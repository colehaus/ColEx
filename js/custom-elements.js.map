{"version":3,"file":"custom-elements.js","sources":["webpack:///custom-elements/menu.wp.es.js","webpack:///custom-elements.wp.es.js","webpack:///custom-elements/tree.wp.es.js","webpack:///custom-elements/swap.wp.es.js","webpack:///libs/geometry.wp.es.js","webpack:///custom-elements/sidenote.wp.es.js"],"sourcesContent":["// @flow\n/* eslint no-undef: \"off\" */\n\nimport $ from 'jquery'\nimport {create, env} from 'sanctuary'\nconst S = create({checkTypes: false, env})\n\nconst defaultHandlers = (el: JQuery) => {\n  if (el.attr('type') === 'radio') {\n    const menu = el.closest('menu')\n    const item = menu.find(`[label=\"${el.text()}\"]`)\n    handleEvent({ tag: 'ITEMSELECT', menu, item })\n  }\n}\n\nconst getMenu = (el: HTMLElement) => $('#' + $(el).closest('[type=\"menu\"]').attr('data-menu'))\n\nconst renderMenuItem = (menuItem: MenuItem): JQuery => {\n  switch (menuItem.tag) {\n    case 'HR':\n      return $('<hr/>')\n    case 'MENUITEM':\n      const li = $('<li/>').text(menuItem.label).attr('type', menuItem.type)\n      if (menuItem.active) {\n        li.attr('checked', 'checked')\n      } else {\n        li.removeAttr('checked')\n      }\n      return li\n    default:\n      throw Error(menuItem.toString())\n  }\n}\n\nconst renderMenu = (menu: Menu): ?JQuery => {\n  switch (menu.tag) {\n    case 'CLOSED':\n      return null\n    case 'OPEN':\n      return $('<ul class=\"menu\"></ul>').append(S.map(renderMenuItem)(menu.items))\n  }\n}\n\ntype MenuItemType = 'radio' | string\n\ntype MenuItem\n  = { tag: 'HR' }\n  | { tag: 'MENUITEM', label: string, type: MenuItemType, active: boolean }\n\ntype Menu\n  = { tag: 'OPEN', items: Array<MenuItem> }\n  | { tag: 'CLOSED' }\n\n// The JQuery declaration seems to be wrong\nconst fixTarget = (target: EventTarget) => HTMLElement = (target: any) // eslint-disable-line no-return-assign\n\nconst parseMenuItem = (menuItem: JQuery): MenuItem => {\n  switch (menuItem.get(0).nodeName) {\n    case 'HR':\n      return { tag: 'HR' }\n    case 'MENUITEM':\n      return { tag: 'MENUITEM',\n        label: menuItem.attr('label'),\n        type: menuItem.attr('type'),\n        active: menuItem.attr('checked') === 'checked'\n      }\n    default:\n      throw Error(menuItem.toString())\n  }\n}\n\nconst parseMenu = (menu: JQuery): Menu =>\n  menu.data('active')\n  ? { tag: 'CLOSED' }\n  : { tag: 'OPEN',\n    items: S.map((el) => parseMenuItem($(el)))(menu.children('menuitem, hr').toArray())\n  }\n\ntype Event\n  = { tag: 'MENUCLICK', menu: JQuery }\n  | { tag: 'ITEMSELECT', item: JQuery, menu: JQuery }\n\nconst handleEvent = (event: Event) => {\n  switch (event.tag) {\n    case 'MENUCLICK':\n      S.pipe([\n        parseMenu,\n        renderMenu,\n        S.toMaybe,\n        S.maybe_(\n          () => {\n            $('ul.menu').remove()\n            event.menu.data('active', false)\n          })(\n          menuDom => {\n            event.menu.append(menuDom)\n            event.menu.data('active', true)\n          }\n        )\n      ])(\n        event.menu\n      )\n      break\n    case 'ITEMSELECT':\n      $('ul.menu').remove()\n      event.menu.data('active', false)\n      S.map(el => $(el).removeAttr('checked'))(event.menu.children().toArray())\n      event.item.attr('checked', 'checked')\n      break\n  }\n}\n\nconst toggleMenu = (ev: JQueryEventObject) => {\n  // Menu shouldn't popup when clicking on interactive element\n  const isInter = [\n    'TEXTAREA',\n    'BUTTON',\n    'INPUT',\n    'OPTION',\n    'SELECT',\n    'DETAILS',\n    'SUMMARY',\n    'A'\n  ].some(tg => fixTarget(ev.target).nodeName === tg)\n  if (isInter) { return }\n  const isPopup = el =>\n    $(el).get(0).nodeName === 'MENU' && $(el).attr('type') === 'popup'\n  const menu = getMenu(fixTarget(ev.target)).filter((_, el) => isPopup(el))\n  if (menu != null) {\n    handleEvent({ tag: 'MENUCLICK', menu: $(menu) })\n  }\n}\n\n$(() => {\n  $('[type=\"menu\"]').each((_, el) => {\n    $(el).click(toggleMenu)\n  })\n})\n\nexport default {getMenu, defaultHandlers}\n\n\n\n// WEBPACK FOOTER //\n// custom-elements/menu.wp.es.js","import 'custom-elements/tree'\nimport 'custom-elements/swap'\nimport 'custom-elements/sidenote'\nimport 'custom-elements/menu'\n\n\n\n// WEBPACK FOOTER //\n// custom-elements.wp.es.js","// @flow\n/* eslint no-undef: \"off\" */\n\nimport $ from 'jquery'\nimport {create, env} from 'sanctuary'\n\nimport menu from 'custom-elements/menu'\nimport sidenote from 'custom-elements/sidenote'\nimport { makeAnimationPromise } from 'libs/util'\n\nconst S = create({checkTypes: false, env})\n\ntype Event\n  = { tag: 'INVISIBLEPARENT', from: JQuery, to: JQuery }\n  | { tag: 'SELECTEDOPEN' }\n  | { tag: 'SELECTEDNEWVISIBLE', from: JQuery, to: JQuery, parent: JQuery }\n\nconst handleEvent = (event: Event) => (resolve: Function, reject: Function) => {\n  switch (event.tag) {\n    case 'INVISIBLEPARENT':\n      event.from.removeClass('open')\n      event.to.addClass('open')\n      resolve()\n      break\n    case 'SELECTEDOPEN':\n      resolve()\n      break\n    case 'SELECTEDNEWVISIBLE':\n      // Flow behaving badly\n      const event_ = event\n      makeAnimationPromise(300, prog => event_.from.css('opacity', 1 - prog))\n        .then(() => {\n          const pho = event_.parent.height()\n          event_.from.css('opacity', 0)\n          event_.to.css('opacity', 0)\n          event_.from.removeClass('open')\n          event_.to.addClass('open')\n          const phn = event_.parent.height()\n          return [pho, phn]\n        }).then(([pho, phn]) =>\n          makeAnimationPromise(300, prog => {\n            event_.to.css('opacity', prog)\n            event_.parent.css('height', pho + (phn - pho) * prog)\n          })\n        ).then(() => {\n          event_.parent.removeAttr('style')\n          event_.from.removeAttr('style')\n          event_.to.removeAttr('style')\n        })\n        .then(resolve)\n      break\n  }\n}\n\nconst choose = (ev: JQueryEventObject) => {\n  const el = $(ev.target)\n  S.map(\n    contentTree => {\n      const contentBranch = $($(contentTree).children().get(el.index()))\n      const event =\n        contentBranch.hasClass('open')\n          ? { tag: 'SELECTEDOPEN' }\n          : contentBranch.parent().is(':visible')\n            ? { tag: 'SELECTEDNEWVISIBLE', from: contentBranch.siblings('.open'), to: contentBranch, parent: contentBranch.parent() }\n            : { tag: 'INVISIBLEPARENT', from: contentBranch.siblings('.open'), to: contentBranch }\n      new Promise(handleEvent(event)).then(() => {\n        sidenote.setNotes()\n        sidenote.fixNotes()\n      })\n    }\n  )(\n    $(`[data-menu=\"${el.closest('menu').attr('id')}\"]`).toArray()\n  )\n  menu.defaultHandlers(el)\n  return false\n}\n\nconst fixTarget = (target: EventTarget) => HTMLElement = (target: any) // eslint-disable-line no-return-assign\n\n$(() => {\n  S.map(el =>\n    $(el).click(({pageY, pageX, target}) => {\n      menu.getMenu(fixTarget(target))\n      .offset({top: pageY, left: pageX})\n      .children('ul.menu').children()\n      .off().click(choose)\n      return false\n    })\n  )(\n    $('[type=\"menu\"]').toArray()\n  )\n\n  MathJax.Hub.Queue(() => {\n    // Messes up rendering if we add to stylesheet\n    $('.MathJax_MathContainer').css('display', 'inline')\n    $('.MathJax_MathContainer > span').css('display', 'inline')\n    // Re-inline fix rendering problem\n    const inlines = $('.switch.inline > li.open')\n    inlines.css('display', 'inline-block')\n    inlines.offset() // Trigger reflow\n    inlines.css('display', 'inline')\n    inlines.removeAttr('style')\n  })\n})\n\n\n\n// WEBPACK FOOTER //\n// custom-elements/tree.wp.es.js","// @flow\n/* eslint no-undef: \"off\" */\n\n// Doesn't currently handle nested swaps\n\nimport $ from 'jquery'\nimport {create, env} from 'sanctuary'\n\nimport sidenote from 'custom-elements/sidenote'\nimport { makeAnimationPromise } from 'libs/util'\nimport { circleFromChord, pointOnCircle } from 'libs/geometry'\n\nconst S = create({checkTypes: false, env})\n\nconst translations = (top: JQuery, bottom: JQuery) => {\n  const bottomToTop = top.offset().top - bottom.offset().top\n  const between = bottom.height() - top.height()\n  const topToBottom = bottom.offset().top - top.offset().top + between\n  return {bottomToTop, between, topToBottom}\n}\n\nconst swapTranslate = (topEl: JQuery, bottomEl: JQuery) => (resolve: Function, reject: Function) => {\n  const betweenEls = topEl.nextUntil(bottomEl)\n  const {bottomToTop, between, topToBottom} = translations(topEl, bottomEl)\n\n  const angle = Math.PI / 4\n  const mkTranslator = (trans: number): (number => string) => {\n    const startAngle = trans <= 0 ? Math.PI + angle : angle\n    const {center, radius} = circleFromChord(startAngle,\n                                             startAngle - 2 * angle,\n                                             {x: 0, y: 0},\n                                             {x: 0, y: trans})\n    return (prog: number): string => {\n      const {x, y} = pointOnCircle(center, radius,\n                                   startAngle - angle * 2 * prog)\n      return `translate(${x}px, ${-y}px)`\n    }\n  }\n  const topTranslator = mkTranslator(topToBottom)\n  const bottomTranslator = mkTranslator(bottomToTop)\n  const betweenTranslator = mkTranslator(between)\n\n  makeAnimationPromise(300, prog => {\n    topEl.css('transform', topTranslator(prog))\n    bottomEl.css('transform', bottomTranslator(prog))\n    betweenEls.css('transform', betweenTranslator(prog))\n  }).then(() => {\n    topEl.removeAttr('style')\n    bottomEl.removeAttr('style')\n    betweenEls.removeAttr('style')\n  }).then(resolve)\n}\n\nconst swap = function () {\n  const arrow = $(this)\n  const p = arrow.parent()\n  const selector = '.' + p.attr('class').replace(' ', '.')\n  const [top, bottom] =\n    (arrow.attr('class') === 'swap-down')\n    ? [p, p.nextAll(selector + ':first')]\n    : [p.prevAll(selector + ':first'), p]\n  new Promise(swapTranslate(top, bottom)).then(() => {\n    swapDom(top, bottom)\n    sidenote.fixNotes()\n    $('.swap-up, .swap-down').remove()\n    decorate()\n  })\n}\n\nconst swapDom = (top: JQuery, bot: JQuery) => {\n  const topNext = top.next()\n  if (topNext[0] === bot[0]) {\n    bot.before(top)\n    top.before(bot)\n  } else {\n    bot.before(top)\n    topNext.before(bot)\n  }\n}\n\nconst decorate = () => {\n  const up = $('<span class=\"swap-up\"></span>')\n  const down = $('<span class=\"swap-down\"></span>')\n  const swaps = $('.swap')\n  const swapGroups = S.groupBy(S.on(S.equals)(el => $(el).attr('class')))(swaps.toArray())\n  const decorateGroup = group => {\n    S.pipe([S.tail, S.map(S.map(el => $(el).prepend(up.clone())))])(group)\n    S.pipe([S.init, S.map(S.map(el => $(el).append(down.clone())))])(group)\n  }\n  swapGroups.forEach(decorateGroup)\n  $('.swap-up, .swap-down').click(swap)\n}\n\n$(decorate)\n\n\n\n// WEBPACK FOOTER //\n// custom-elements/swap.wp.es.js","// @flow\n/* eslint no-undef: \"off\" */\n\nexport type Coordinate = {x: number, y: number}\n\nconst distance = (coord1: Coordinate, coord2: Coordinate): number =>\n  Math.hypot(coord1.x - coord2.x, coord1.y - coord2.y)\n\nconst circleFromChord = (startRads: number, stopRads: number, startCoord: Coordinate, stopCoord: Coordinate): {radius: number, center: Coordinate} => {\n  const radius = distance(startCoord, stopCoord) /\n    Math.sin(Math.abs(stopRads - startRads) / 2) / 2\n  const center = pointOnCircle(startCoord, radius, startRads + Math.PI)\n  return {radius, center}\n}\n\nconst pointOnCircle = ({x, y}: Coordinate, radius: number, angle: number): Coordinate => ({\n  x: x + Math.cos(angle) * radius,\n  y: y + Math.sin(angle) * radius\n})\n\nexport { distance, circleFromChord, pointOnCircle }\n\n\n\n// WEBPACK FOOTER //\n// libs/geometry.wp.es.js","// @flow\n/* eslint no-undef: \"off\" */\n\nimport $ from 'jquery'\nimport {create, env} from 'sanctuary'\nconst S = create({checkTypes: false, env})\n\nconst getReferrer = (el: JQuery): ?JQuery =>\n  S.pipe([\n    S.toMaybe,\n    S.map(id => $('#' + id.slice(1))),\n    S.maybeToNullable\n  ])(\n    el.find('a').last().attr('href')\n  )\n\nconst fixNotes = () => {\n  S.reduce(\n    prevBot => _el => {\n      const el = $(_el)\n      el.offset((_1, {top, left}) =>\n        S.pipe([\n          S.toMaybe,\n          S.maybe_(() => {\n            prevBot = top + el.outerHeight(true)\n            return {top, left}\n          })(\n            ref => {\n              const top = S.max(ref.prev().offset().top)(prevBot)\n              prevBot = top + el.outerHeight(true)\n              return {top, left}\n            }\n          )\n        ])(\n          getReferrer(el)\n        )\n      )\n      return prevBot\n    })(\n    0)(\n    $('.sidenote').toArray())\n}\n\nconst setNotes = () => {\n  const addSidenote = el => {\n    // Putting block elements in a <p> auto-closes it so we put it immediately outside\n    const referrer = getReferrer(el)\n    if (referrer != null) {\n      const noted = referrer.prev()\n      if (noted.is(':visible')) {\n        const p = noted.closest('p');\n        (p.length === 0 ? noted : p).before('<aside class=\"sidenote\">' + $(el).html() + '</aside>')\n      }\n    }\n  }\n  const delink = () => {\n    $('.noted').next().hide()\n    $('.sidenote').each((_, el) => {\n      $(el).find('a').last().hide()\n    })\n  }\n\n  $('.footnotes').hide()\n  $('details').each((_, el) => {\n    observer.observe(el, {attributes: true})\n  })\n  $('.sidenote').not('#warnings').remove()\n  $('.footnotes > ol > li').each((_, el) => {\n    addSidenote($(el))\n  })\n  delink()\n}\n\nconst observer = new MutationObserver(fixNotes)\n\nconst removeNotes = () => {\n  observer.disconnect()\n  $('.sidenote').not('#warnings').remove()\n  $('.noted').next().show()\n  $('.footnotes').show()\n}\n\nconst addOrRemoveNotes = () => {\n  const emWidth = $(window).width() / parseFloat($(\"html\").css(\"font-size\"))\n  if (emWidth > 60) {\n    setNotes()\n    // $FlowFixMe\n    document.fonts.ready.then(fixNotes)\n    MathJax.Hub.Queue(() => {\n      fixNotes()\n    })\n  } else {\n    removeNotes()\n  }\n}\n\n$(() => {\n  addOrRemoveNotes()\n  $(window).resize(addOrRemoveNotes)\n})\n\nexport default {setNotes, fixNotes}\n\n\n\n// WEBPACK FOOTER //\n// custom-elements/sidenote.wp.es.js"],"mappings":";;;;;;;;;;;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAZA;AAcA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAJA;AAMA;AACA;AAWA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAHA;AAKA;AACA;AAVA;AAYA;AACA;AACA;AAIA;AADA;AACA;AAOA;AACA;AACA;AACA;AAMA;AACA;AACA;AAEA;AACA;AACA;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AAzBA;AA2BA;AACA;AACA;AACA;AACA;AAUA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;AC3IA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;;;;;;;;;;;;;;;;;ACDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAhCA;AAkCA;AACA;AACA;AACA;AACA;AAEA;AACA;AAMA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAIA;AACA;AACA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;ACtGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACxFA;AAJA;AACA;AAMA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAFA;AACA;;;;;;;;;;;;;;ACfA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAQA;AACA;AAEA;AACA;AAIA;AACA;AACA;AAEA;AACA;AACA;AACA;AAMA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;A","sourceRoot":""}